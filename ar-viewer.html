<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Viewer - Student Project</title>

    <!-- A-Frame and AR.js for markerless AR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 20px;
        }

        #loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .loading-subtitle {
            font-size: 14px;
            opacity: 0.9;
            max-width: 280px;
        }

        /* AR Controls Overlay */
        #ar-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            z-index: 100;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .ar-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ar-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.3);
        }

        .ar-btn.primary {
            background: #667eea;
            border-color: #667eea;
        }

        /* Info Panel */
        #info-panel {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 100;
            text-align: center;
        }

        /* Error State */
        #error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 30px;
        }

        #error-screen.visible {
            display: flex;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .error-message {
            font-size: 14px;
            opacity: 0.8;
            max-width: 300px;
            line-height: 1.6;
        }

        .error-btn {
            margin-top: 25px;
            background: #667eea;
            border: none;
            color: white;
            padding: 14px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
        }

        /* Fallback 3D View */
        #fallback-container {
            display: none;
            width: 100%;
            height: 100%;
        }

        #fallback-container.visible {
            display: block;
        }

        a-scene {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-title">Initializing AR</div>
        <div class="loading-subtitle">Point your camera at a flat surface to place the 3D objects</div>
    </div>

    <!-- Error Screen -->
    <div id="error-screen">
        <div class="error-icon">üì±</div>
        <div class="error-title">AR Not Available</div>
        <div class="error-message">
            Your device or browser doesn't support AR.
            Try using Safari on iOS or Chrome on Android.
        </div>
        <button class="error-btn" onclick="showFallbackView()">View in 3D Instead</button>
    </div>

    <!-- AR Scene Container -->
    <div id="ar-container">
        <a-scene id="ar-scene" embedded
            arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
            vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true; antialias: true;" gesture-detector>
            <!-- Camera -->
            <a-camera gps-camera rotation-reader></a-camera>

            <!-- Lights -->
            <a-light type="ambient" intensity="1.0" color="#ffffff"></a-light>
            <a-light type="directional" intensity="0.8" position="5 10 7" color="#ffffff"></a-light>

            <!-- Objects Container - objects will be added here dynamically -->
            <a-entity id="ar-objects" position="0 0 -3" scale="0.5 0.5 0.5"></a-entity>
        </a-scene>
    </div>

    <!-- Fallback 3D View (non-AR) -->
    <div id="fallback-container">
        <a-scene id="fallback-scene" embedded vr-mode-ui="enabled: false">
            <a-camera position="0 2 5" look-controls wasd-controls></a-camera>
            <a-light type="ambient" intensity="0.8"></a-light>
            <a-light type="directional" position="2 4 3" intensity="0.6"></a-light>
            <a-plane position="0 0 0" rotation="-90 0 0" width="10" height="10" color="#4a5580" opacity="0.5"></a-plane>
            <a-entity id="fallback-objects"></a-entity>
        </a-scene>
    </div>

    <!-- Info Panel -->
    <div id="info-panel">
        <span id="object-count">0</span> objects loaded ‚Ä¢ Move phone to explore
    </div>

    <!-- AR Controls -->
    <div id="ar-controls">
        <button class="ar-btn" onclick="resetPosition()">üîÑ Reset</button>
        <button class="ar-btn" onclick="toggleScale()">üìè Resize</button>
        <button class="ar-btn primary" onclick="window.close()">‚úï Close</button>
    </div>

    <script>
        // Parse scene data from URL
        const params = new URLSearchParams(window.location.search);
        const sceneParam = params.get('scene');
        const groupId = params.get('group') || '1';
        let sceneData = [];
        let currentScale = 0.5;
        let arObjectsContainer;

        // Check for AR support
        function checkARSupport() {
            // Check if on mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            // Check for camera/getUserMedia support
            const hasMediaDevices = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;

            if (!isMobile) {
                showError("AR works best on mobile devices. Please scan the QR code with your phone.");
                return false;
            }

            if (!hasMediaDevices) {
                showError("Camera access is required for AR. Please allow camera permissions.");
                return false;
            }

            return true;
        }

        function showError(message) {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('error-screen').classList.add('visible');
            document.querySelector('.error-message').textContent = message;
        }

        function showFallbackView() {
            document.getElementById('error-screen').classList.remove('visible');
            document.getElementById('ar-container').style.display = 'none';
            document.getElementById('fallback-container').classList.add('visible');
            loadObjectsIntoContainer(document.getElementById('fallback-objects'));
        }

        // Load scene data from URL
        function loadSceneData() {
            if (!sceneParam) {
                console.log('No scene data in URL');
                // Create demo objects if no scene data
                sceneData = [
                    { type: 'box', color: '#e74c3c', position: { x: 0, y: 1, z: 0 }, scale: { x: 1, y: 1, z: 1 } },
                    { type: 'sphere', color: '#3498db', position: { x: 1.5, y: 1, z: 0 }, scale: { x: 1, y: 1, z: 1 } }
                ];
                return;
            }

            try {
                sceneData = JSON.parse(atob(sceneParam));
                console.log('Loaded scene with', sceneData.length, 'objects');
            } catch (e) {
                console.error('Failed to parse scene data:', e);
                sceneData = [];
            }
        }

        // Create A-Frame entities from scene data
        function loadObjectsIntoContainer(container) {
            if (!container) return;

            sceneData.forEach((obj, index) => {
                const entity = document.createElement('a-entity');
                entity.id = `ar-obj-${index}`;

                const pos = obj.position || { x: 0, y: 1, z: 0 };
                entity.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);

                // Set geometry based on type
                const geomAttrs = {
                    primitive: obj.type || 'box'
                };

                if (obj.type === 'sphere') {
                    geomAttrs.radius = 0.5;
                } else if (obj.type === 'cylinder') {
                    geomAttrs.height = 1;
                    geomAttrs.radius = 0.5;
                } else if (obj.type === 'cone') {
                    geomAttrs.height = 1;
                    geomAttrs.radiusBottom = 0.5;
                    geomAttrs.radiusTop = 0.1;
                } else if (obj.type === 'dodecahedron') {
                    geomAttrs.radius = 0.5;
                }

                entity.setAttribute('geometry', geomAttrs);
                entity.setAttribute('material', { color: obj.color || '#ffffff' });

                const scale = obj.scale || { x: 1, y: 1, z: 1 };
                entity.setAttribute('scale', `${scale.x} ${scale.y} ${scale.z}`);

                container.appendChild(entity);
            });

            document.getElementById('object-count').textContent = sceneData.length;
        }

        // Reset position of AR objects
        function resetPosition() {
            if (arObjectsContainer) {
                arObjectsContainer.setAttribute('position', '0 0 -3');
                arObjectsContainer.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
            }
        }

        // Toggle scale of AR objects
        function toggleScale() {
            const scales = [0.3, 0.5, 0.75, 1.0];
            const currentIndex = scales.indexOf(currentScale);
            const nextIndex = (currentIndex + 1) % scales.length;
            currentScale = scales[nextIndex];

            if (arObjectsContainer) {
                arObjectsContainer.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSceneData();

            // Check AR support
            if (!checkARSupport()) {
                return;
            }

            // Wait for A-Frame scene to load
            const arScene = document.getElementById('ar-scene');
            arScene.addEventListener('loaded', () => {
                arObjectsContainer = document.getElementById('ar-objects');
                loadObjectsIntoContainer(arObjectsContainer);

                // Hide loading overlay after a short delay
                setTimeout(() => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                }, 1500);
            });

            // Handle camera errors
            arScene.addEventListener('camera-error', () => {
                showError("Could not access camera. Please check permissions and try again.");
            });
        });

        // Request camera permission explicitly for iOS
        async function requestCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (e) {
                console.error('Camera permission denied:', e);
                return false;
            }
        }
    </script>
</body>

</html>